change c ants_masking

1 using unmasked images and combined mask as fixed and moving image mask 
(for fixed:linearly transformed combined mask)
-> this makes the transformation stretch out less to the edges (at least in all directions but phase encoding
-> but it seems a bit deformed, the deformation seems to be where the anatomical has a white 'hole' 
-> in fact, it seems to go

2 same but with sampling percentage increased from 0.3 - 1.0
-> this doesn't change a thing compared to 1!

3 invert unmasked image and use both unmasked images for nonlinear
-> of course, this doesn't change too much... 
-> gaps in the brain image seem to be a problem, as they are zero before, they have very high values afterwards
-> actually the masking in ants might be slightly better...?

4 keeping changes but trying drastically more iterations (not more levels though for now) as with masking
pulling to the edges seems to be less extreme
-> looks pretty good, the only difference on the first glance being, that the epi is stretched more to the front
but less to the back. whyever
-> the cc and the veins match better. for some weird reason this doesn't go that much overboard
-> jay! enough for the day
-> BUT: ventral OFC maybe less improved? (change restrictions?)

tomorrow: dilation, inversion, restriction

5 changing dilation to 1
-> worse, only little improvement against nonlinear
-> weird because the mask actually seems good enough

6 changing dilation to 2
-> in between dilation 2 and 3

7 no masking whatsoever
-> totally not

8 changing dilation back to 3 for now, setting sampling strategy to None, moving on to inversion
-> as expected just like c4

#########################################################

change d inversion
1 change inversion to robust min/max for epi (not for anat though)
-> inv anatomical looks better like this, keep the change, but for the nonlinear it doesn't change a thing
+++++++++ problem, that i didn't see in ants_masking: stretching out to the back+++++++++++++++++++++

2 skip inversion completely
-> this is interesting, it does exactly what it is supposed to do, pushing out to the front, in at the back, just maybe not right enough
-> no actually in the other brains it is too much of the squeezing in at the back

3 recip instead of inversion
-> weird in the back, stretches out to the 0 areas?

4 use ribbon mask dil 1 before recip to avoid 'holes'
-> looks pretty good, compared to c8 it spreads more to the borders again (as no masking in ants)
-> but using dil1 that doesn't seem too much of a problem
-> though: does it maybe stretch out too much to the back? and in dorso-ventral directions?
-> still not happy with this border stretching
-> since epi wasn't masked cerebellum/brain stem screwed up

5 same with masking epi within ants (with the small dil1 mask)
-> doesn't change a thing

6 same with masking both in ants
-> no, this ants masking doesn't really seem to work after all. at least not with the dil1 mask
-> it stops after fewer interations and gives out a weird squiggled thing

7 like 6 but ants mask dil3 (t1 mask dil1 though)
-> no, this is too big. it is no good to use this big mask

8 like 4 but also masking epi before again
-> looks better, but this again seems to do a bit too much stretching, both a-p and d-v
-> actually has stopped iterating itself (good)

9 like 8 but with restricting def to y direction
-> no no
-> reverse the change

++++++ actually 8 looks pretty reasonable, still it is a bit overboard (e.g. 11182 dorsal) but still the best so far.
also better than old solution (a) ++++++++

###############################################################################

change e: finetuning of parameters

1 w/o any dilation of the ribbon mask
-> definitely better

#############################################################################

f any (+ cleaning up workflow)

1 dilation to 0 masking in ants, recip
-> really weird, stretches out somewhere


2 dil back to 3
-> really deformed, if i am right the only difference to c8, where it kind of worked
is the inversion (i.e. background = 0)

3 try mask in epi space for both images in ants

###############################################################################################

g testing bsplinesyn

1 changing to bpslinesyn with parameters as described in paper
(also replacing file_to_list)
-> this is less extreme compared to the old approach (a) but it also recovers less. 
-> maybe try this without any masking?

2 like 1 but without any masking
-> too big, cerebellum/brain stem screwed

3 like 1 but with recip
-> this stretches out more than 1, but not very favourable (in the middle)

4 like 3 but with tighter mask dil0
-> not soo bad, recovers not too nice but good in terms of borders
-> cc doesn't look good

########################################################################


i include affine step again
-> affine doesn't look good, nonlinear even worse, very big

#########################################################################
j masking twice as suggested in forum
1 dil 3 intersect with fov for masking in ants (both), dil3 ero3 for masking anatomy before
-> promising? but actually a bit too small now, ventricles compressed, try dilating the mask even more for usage in ants
-> images don't totally fit. --> turns out to be problem with nipype 'bugfix'

2 dilating ants mask by 10, calculating tight mask directly from ribbon
-> should probably dilate and erode in steps, looks a bit edgy
-> this looks fabulous!
- maybe still a bit too much in the center, problems in cerebellum/brainstem, etc. but still!

3 try with alternative inversion (recip)
-> even better (borders and gyri etc match much better)
-> but problems with cerebellum 
-> AND: problem with posterior part of cc and veins -> stretches too much now, not with other inversion. (probably try less dilation) 
-> AND: problems where EPI doesn't cover anatomy (probably mask this out in tight mask?)

4 try orginal inversion but masking afterwards
-> really really good. 
-> only things: 
-> cerebellum/brain stem: try less dilation
-> still a bit peculiar at FOV border: intersect fov with tight mask
-> values of inverted brain very high, think about masking-inversion-remasking?


5 reducing dilation back to 3
(and trying to fix ants apply problem)
-> better
-> fov still a problem
-> cerebellum/brainstem still a problem where in dil3 mask
-> temporal lobes a problem where hardly in mask
-> would need larger mask but then tight mask for whole brain

6 intersecting both the tight and the dilated mask with the fov
-> doesn't seem to change anything
-> problems of weird distortion near that border remain
-> this is really only for the case where the epi doesn't cover the full anatomy, otherwise looks good

7 inversion back to epi -r instead of -R
(probably nothing to do with this, just so)
-> doesn't change. keep and change in master

8 restrict to phase encoding direction
-> no too much difference, maybe stick with it since it is theoretically cleaner
******* actually makes undesirable deformations in axial view worse, UNDO in 10 **********

9 erode fov by 3 for the tight mask to keep borders, then dilate whole intersect
-> erode doesn't work
 
9 new: use mcflirt mean which is already missing a slice
-> still not, think about this again
-> has been fixed in nipype, try with var image

10 back to not restrict completely to phase encoding, for fov, use var image which should be clipped
-> doesn't work , mask isn't clipped, despite image is (probably just has a zero line)




####################################################
k different options starting from fixed masking

1 fewer iterations : 20:10 (and undo j9)
-> didn't help with the clipping problem
-> very little difference
UNDO

2 bspline syn
-> a bit too constrained, doesn't mess up so much but doesn't help so much either

3 bspline syn try more iterations and levels, shrink and smoothing as in paper
-> gets a bit better but not fully there as with syn (for 144)
-> actually it seems pretty good for 0109 and elevating the clipping problem
-> maybe this is less sensitiv to masking, then i could use a bigger mask, maybe just skull stripping? 
(because as with syn there are still problems in the back where it deforms despite there shouldn't even really be
distortions, the epi is a bit bigger after all, maybe segmentation including csf?)

4 bspline syn with less regularisation: reduce spline distance to 16
-> this was actually more regularisation ?! 
-> also i don't like it too much in posterior parts

******* UNDO restrict def to phase encoding (some deformation in other directions seems to alleviate weird def)

5 bspline with distance 40 and undo phase encoding restriction
-> no, this deforms too much 



###########################################

keep in mind: problem to meet large vein, particularly 0144, this stretches to much in general
would this be helped with having  a full mask?
dilate/erode in steps
mask also epi again before?
changing fixed/moving
changing iterations
other algorithm/metric? (mi after all?)


